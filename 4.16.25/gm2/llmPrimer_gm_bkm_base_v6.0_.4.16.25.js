javascript:(function(){if(document.getElementById('llmPrimer-panel')){const a=document.getElementById('llmPrimer-panel');a.style.display=a.style.display==='none'?'block':'none';return}const b=document.createElement('script');b.src='new_gm_llmPrimer_bkm_kbLoader_v2.0_4.14.25.js';/* <-- Ensure this points to your UPDATED loader file */document.head.appendChild(b);b.onload=c;b.onerror=function(){alert('Failed to load knowledge base data script.')};function c(){try{if(typeof kbCategory==='undefined'||!Array.isArray(kbCategory)||typeof kbDomain==='undefined'||!Array.isArray(kbDomain)){throw new Error('Knowledge base data (kbCategory or kbDomain) not found or invalid after loading script. Check the kbLoader file.')}const a=document.createElement('div');a.id='llmPrimer-panel';a.style.position='fixed';a.style.top='20px';a.style.right='20px';a.style.width='300px';a.style.backgroundColor='#fff';a.style.border='1px solid #ccc';a.style.borderRadius='5px';a.style.padding='15px';a.style.boxShadow='0 4px 8px rgba(0,0,0,.1)';a.style.zIndex='10000';a.style.fontFamily='Arial,sans-serif';a.style.fontSize='14px';a.style.color='#333';const b=document.createElement('div');b.style.display='flex';b.style.justifyContent='space-between';b.style.alignItems='center';b.style.marginBottom='15px';const c=document.createElement('h3');c.textContent='llmPrimer';c.style.margin='0';c.style.fontSize='16px';c.style.fontWeight='bold';b.appendChild(c);const d=document.createElement('div');d.style.display='flex';d.style.gap='5px';const e=document.createElement('button');e.id='llmPrimer-theme-btn';e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';e.title='Toggle theme';e.style.border='none';e.style.background='none';e.style.cursor='pointer';e.style.fontSize='16px';e.addEventListener('click',u);d.appendChild(e);const f=document.createElement('button');f.id='llmPrimer-toggle-btn';f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>';f.title='Toggle panel';f.style.border='none';f.style.background='none';f.style.cursor='pointer';f.style.fontSize='16px';f.addEventListener('click',v);d.appendChild(f);const g=document.createElement('button');g.id='llmPrimer-close-btn';g.innerText='✕';g.title='Close panel';g.style.border='none';g.style.background='none';g.style.cursor='pointer';g.style.fontSize='16px';g.addEventListener('click',w);d.appendChild(g);b.appendChild(d);a.appendChild(b);const h=document.createElement('label');h.textContent='Select Category:';h.style.display='block';h.style.marginBottom='5px';h.style.fontSize='14px';a.appendChild(h);const i=document.createElement('select');i.className='categorySelect';i.style.width='100%';i.style.padding='5px';i.style.marginBottom='15px';i.style.borderRadius='3px';i.style.border='1px solid #ccc';const j=document.createElement('option');j.value='';j.textContent='-- Select a category --';i.appendChild(j);kbCategory.forEach(a=>{const b=document.createElement('option');b.value=a.id;b.textContent=a.title;i.appendChild(b)});a.appendChild(i);const k=document.createElement('label');k.textContent='Select Knowledge Base:';k.style.display='block';k.style.marginBottom='5px';k.style.fontSize='14px';a.appendChild(k);const l=document.createElement('select');l.className='knowledgeBaseSelect';l.style.width='100%';l.style.padding='5px';l.style.marginBottom='15px';l.style.borderRadius='3px';l.style.border='1px solid #ccc';l.disabled=true;const m=document.createElement('option');m.value='';m.textContent='-- Select a knowledge base --';l.appendChild(m);a.appendChild(l);const n=document.createElement('div');n.style.display='flex';n.style.justifyContent='space-between';n.style.gap='10px';const o=document.createElement('button');o.id='llmPrimer-inject-btn';o.innerText='Inject Prompt';o.style.padding='8px 15px';o.style.borderRadius='3px';o.style.border='1px solid #ccc';o.style.backgroundColor='#f0f0f0';o.style.cursor='pointer';o.style.flex='1';o.disabled=true;o.addEventListener('click',r);n.appendChild(o);const p=document.createElement('button');p.id='llmPrimer-copy-btn';p.innerText='Copy Prompt';p.style.padding='8px 15px';p.style.borderRadius='3px';p.style.border='1px solid #ccc';p.style.backgroundColor='#f0f0f0';p.style.cursor='pointer';p.style.flex='1';p.disabled=true;p.addEventListener('click',t);n.appendChild(p);a.appendChild(n);document.body.appendChild(a);i.addEventListener('change',function(){z(this.value);l.disabled=!this.value;o.disabled=true;p.disabled=true});l.addEventListener('change',function(){o.disabled=!this.value;p.disabled=!this.value});if(kbCategory.length>0){const firstCategoryId=kbCategory[0].id;i.value=firstCategoryId;z(firstCategoryId);if(l.options.length>1){l.disabled=false;l.value=l.options[1].value;o.disabled=false;p.disabled=false}else{l.disabled=true}}x()}catch(a){console.error('Error initializing llmPrimer panel:',a);alert('Failed to initialize llmPrimer: '+a.message)}}function z(a){try{const b=document.querySelector('.knowledgeBaseSelect');if(!b){throw new Error('Knowledge base select element not found')}while(b.options.length>1){b.remove(1)}const c=kbDomain.filter(b=>b.category===a);c.forEach(a=>{const c=document.createElement('option');c.value=a.id;c.textContent=a.title;b.appendChild(c)});if(c.length>0){b.value=c[0].id;const a=document.getElementById('llmPrimer-inject-btn');const d=document.getElementById('llmPrimer-copy-btn');if(a&&d){a.disabled=false;d.disabled=false}}else{b.value='';const a=document.getElementById('llmPrimer-inject-btn');const d=document.getElementById('llmPrimer-copy-btn');if(a&&d){a.disabled=true;d.disabled=true}}}catch(a){console.error('Error populating knowledge bases:',a);alert('Failed to populate knowledge bases: '+a.message)}}async function q(){/* MODIFIED: Now async and fetches content */try{const a=document.querySelector('.knowledgeBaseSelect');if(!a){throw new Error('Knowledge base select element not found')}const b=a.value;if(!b){return null}/* Return null if nothing selected */const c=kbDomain.find(a=>a.id===b);if(!c||!c.markDownUrl){/* Check for markDownUrl */throw new Error('Selected knowledge base definition or URL not found.')}const d=c.markDownUrl;/* Display simple loading feedback */const injectBtn=document.getElementById('llmPrimer-inject-btn');const copyBtn=document.getElementById('llmPrimer-copy-btn');const originalInjectText=injectBtn?injectBtn.innerText:'Inject Prompt';const originalCopyText=copyBtn?copyBtn.innerText:'Copy Prompt';if(injectBtn)injectBtn.innerText='Loading...';if(copyBtn)copyBtn.innerText='Loading...';if(injectBtn)injectBtn.disabled=true;if(copyBtn)copyBtn.disabled=true;try{const e=await fetch(d);if(!e.ok){throw new Error(`HTTP error! Status: ${e.status} - ${e.statusText}. Failed to fetch ${d}. Check URL and CORS headers.`)}const f=await e.text();/* Restore buttons AFTER successful fetch */if(injectBtn){injectBtn.innerText=originalInjectText;injectBtn.disabled=false;}if(copyBtn){copyBtn.innerText=originalCopyText;copyBtn.disabled=false;}return f}catch(fetchError){/* Restore buttons on fetch error */if(injectBtn){injectBtn.innerText=originalInjectText;injectBtn.disabled=false;}if(copyBtn){copyBtn.innerText=originalCopyText;copyBtn.disabled=false;}console.error('Fetch error:',fetchError);throw new Error(`Failed to fetch content from URL: ${d}. ${fetchError.message}`)/* Propagate error */}}catch(a){console.error('Error getting knowledge base content:',a);/* Restore buttons if error happens before fetch */const injectBtn=document.getElementById('llmPrimer-inject-btn');const copyBtn=document.getElementById('llmPrimer-copy-btn');if(injectBtn&&injectBtn.innerText==='Loading...'){injectBtn.innerText=injectBtn.dataset.originalText||'Inject Prompt';injectBtn.disabled=false}if(copyBtn&©Btn.innerText==='Loading...'){copyBtn.innerText=copyBtn.dataset.originalText||'Copy Prompt';copyBtn.disabled=false}alert(`Error: ${a.message}`);return null/* Return null on error */}}function p(){console.log('Prompt injected successfully.')}function r(){/* MODIFIED: Calls the now async y() */y().catch(err=>{/* Catch potential errors from y() itself */console.error("Error during injection process:",err);alert("Injection failed. See console for details.")})}async function y(){/* MODIFIED: Now async to await content */try{const a=await q();/* Wait for content */if(a===null){/* Check for null which indicates an error occurred in q() */alert('Could not retrieve knowledge base content. Please check selection or URL.');return}if(!a){alert('No knowledge base content fetched or content is empty.');return}const c=document.querySelector("#dialog-input-textarea");if(!c){alert("Target injection placeholder (#dialog-input-textarea) not found!");return}c.value=a;/* Use .value for textarea */c.dispatchEvent(new Event("input",{bubbles:true}));setTimeout(()=>{const a=document.querySelector('button[data-testid="dialog-input-send"]');if(a){a.click();p()}else{alert("Target send button ('button[data-testid=\"dialog-input-send\"]') not found!")}},100)/* Slight delay */}catch(a){console.error('Error injecting prompt:',a);alert('Failed to inject prompt: '+a.message)}}async function t(){/* MODIFIED: Now async to await content */try{const a=await q();/* Wait for content */if(a===null){alert('Could not retrieve knowledge base content. Please check selection or URL.');return}if(!a){alert('No knowledge base content fetched or content is empty!');return}if(navigator.clipboard&&navigator.clipboard.writeText){try{await navigator.clipboard.writeText(a);const copyBtn=document.getElementById('llmPrimer-copy-btn');if(copyBtn){const originalText=copyBtn.innerText;copyBtn.innerText='✓ Copied!';setTimeout(()=>{if(copyBtn.innerText==='✓ Copied!'){/* Avoid race conditions */copyBtn.innerText=originalText}},2000)}else{alert('Copied!')}}catch(err){console.error('Clipboard API writeText error:',err);alert('Failed to copy using Clipboard API: '+err.message)}}else{/* Fallback method */const c=document.createElement('textarea');c.value=a;c.style.position='fixed';c.style.left='-999999px';c.style.top='-999999px';document.body.appendChild(c);c.focus();c.select();let d=false;try{d=document.execCommand('copy')}catch(execErr){console.error('execCommand copy error:',execErr)}document.body.removeChild(c);if(d){const copyBtn=document.getElementById('llmPrimer-copy-btn');if(copyBtn){const originalText=copyBtn.innerText;copyBtn.innerText='✓ Copied!';setTimeout(()=>{if(copyBtn.innerText==='✓ Copied!'){copyBtn.innerText=originalText}},2000)}else{alert('Copied!')}}else{alert('Failed to copy text using fallback method. Try again.')}}}catch(a){console.error('Error copying prompt:',a);alert('Failed to copy prompt: '+a.message)}}function u(){try{const a=document.getElementById('llmPrimer-panel');if(!a){throw new Error('Panel not found')}const b=a.getAttribute('data-theme')==='dark';if(b){a.setAttribute('data-theme','light');a.style.backgroundColor='#fff';a.style.color='#333';a.style.border='1px solid #ccc';const b=a.querySelectorAll('button:not([id=\"llmPrimer-theme-btn\"]):not([id=\"llmPrimer-toggle-btn\"]):not([id=\"llmPrimer-close-btn\"])');b.forEach(a=>{a.style.backgroundColor='#f0f0f0';a.style.color='#333';a.style.border='1px solid #ccc'});const c=a.querySelectorAll('select');c.forEach(a=>{a.style.backgroundColor='#fff';a.style.color='#333';a.style.border='1px solid #ccc'});const d=document.getElementById('llmPrimer-theme-btn');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"5\"/><line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"/><line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"/><line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"/><line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\"/><line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\"/><line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\"/><line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\"/><line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\"/></svg>'}else{a.setAttribute('data-theme','dark');a.style.backgroundColor='#333';a.style.color='#fff';a.style.border='1px solid #555';const b=a.querySelectorAll('button:not([id=\"llmPrimer-theme-btn\"]):not([id=\"llmPrimer-toggle-btn\"]):not([id=\"llmPrimer-close-btn\"])');b.forEach(a=>{a.style.backgroundColor='#444';a.style.color='#fff';a.style.border='1px solid #666'});const c=a.querySelectorAll('select');c.forEach(a=>{a.style.backgroundColor='#444';a.style.color='#fff';a.style.border='1px solid #666'});const d=document.getElementById('llmPrimer-theme-btn');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\"/></svg>'}localStorage.setItem('llmPrimer-theme',b?'light':'dark')}catch(a){console.error('Error toggling theme:',a)}}function x(){try{const a=document.getElementById('llmPrimer-panel');if(!a){throw new Error('Panel not found')}const b=localStorage.getItem('llmPrimer-theme')||'light';if(b==='dark'){a.setAttribute('data-theme','dark');a.style.backgroundColor='#333';a.style.color='#fff';a.style.border='1px solid #555';const b=a.querySelectorAll('button:not([id=\"llmPrimer-theme-btn\"]):not([id=\"llmPrimer-toggle-btn\"]):not([id=\"llmPrimer-close-btn\"])');b.forEach(a=>{a.style.backgroundColor='#444';a.style.color='#fff';a.style.border='1px solid #666'});const c=a.querySelectorAll('select');c.forEach(a=>{a.style.backgroundColor='#444';a.style.color='#fff';a.style.border='1px solid #666'}); /* Corrected border style */const d=document.getElementById('llmPrimer-theme-btn');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\"/></svg>'}else{a.setAttribute('data-theme','light');a.style.backgroundColor='#fff';a.style.color='#333';a.style.border='1px solid #ccc';const b=a.querySelectorAll('button:not([id=\"llmPrimer-theme-btn\"]):not([id=\"llmPrimer-toggle-btn\"]):not([id=\"llmPrimer-close-btn\"])');b.forEach(a=>{a.style.backgroundColor='#f0f0f0';a.style.color='#333';a.style.border='1px solid #ccc'});const c=a.querySelectorAll('select');c.forEach(a=>{a.style.backgroundColor='#fff';a.style.color='#333';a.style.border='1px solid #ccc'});const d=document.getElementById('llmPrimer-theme-btn');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"5\"/><line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"/><line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"/><line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"/><line x1=\"18.36\" y1=\"18.36\" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'}}catch(a){console.error('Error applying initial theme:',a)}}function v(){try{const a=document.getElementById('llmPrimer-panel');if(!a){throw new Error('Panel not found')}const b=Array.from(a.children).slice(1);const c=a.getAttribute('data-minimized')==='true';const d=document.getElementById('llmPrimer-toggle-btn');if(c){b.forEach(a=>{a.style.display=''});a.setAttribute('data-minimized','false');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><line x1=\"3\" y1=\"9\" x2=\"21\" y2=\"9\"/></svg>'}else{b.forEach(a=>{a.style.display='none'});a.setAttribute('data-minimized','true');d.innerHTML='<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"/></svg>'}}catch(a){console.error('Error toggling panel:',a)}}function w(){try{const a=document.getElementById('llmPrimer-panel');if(a){a.remove()}}catch(a){console.error('Error closing panel:',a)}}})();