window.kbResearch = {
  name: "Research Best Practices",
  features: {
    darkPatterns: {
      title: "Dark and Deceptive Patterns",
      considerations: [
        "Identify high-level manipulation strategies across contexts",
        "Analyze meso-level patterns bridging strategies and implementations",
        "Detect low-level interface elements that exploit user behavior",
        "Map dark patterns across different user journeys",
        "Consider contextual factors affecting pattern effectiveness",
        "Evaluate severity and impact of different pattern types",
        "Recognize pattern combinations that amplify manipulation"
      ],
      principles: [
        "Hierarchical classification",
        "Context sensitivity",
        "User impact measurement",
        "Pattern detection methodology",
        "Cross-disciplinary analysis",
        "Ethical design alternatives",
        "Regulatory compliance"
      ],
      userStories: [
        "A UX auditor needs to identify dark patterns in an e-commerce checkout flow",
        "A regulatory analyst requires a framework to categorize manipulative design elements",
        "A design team wants to review their interfaces for unintentional dark patterns",
        "A researcher needs to document dark pattern prevalence across industry sectors",
        "A compliance officer needs to audit interfaces for regulatory violations",
        "A UX team needs ethical alternatives to common dark patterns"
      ]
    },
    disneyMethod: {
      title: "The Disney Method",
      considerations: [
        "Implement dreamer, realist, and critic thinking phases",
        "Use role assignments for team collaboration",
        "Design appropriate documentation for each phase",
        "Support transitions between thinking modes",
        "Create safe spaces for divergent thinking",
        "Balance creative and analytical approaches",
        "Adapt for different research contexts"
      ],
      principles: [
        "Sequential thinking modes",
        "Role separation",
        "Constructive evaluation",
        "Creative freedom",
        "Practical implementation"
      ],
      userStories: [
        "A UX researcher needs to brainstorm innovative study methods",
        "A research team wants to critique protocols without stifling creativity",
        "A solo practitioner needs to balance imagination with feasibility"
      ]
    },
    interviews: {
      title: "User Interview Techniques",
      considerations: [
        "Design strategic questioning sequences",
        "Create comfortable interview environments",
        "Avoid leading questions",
        "Document insights systematically",
        "Manage time while allowing for exploration",
        "Recruit diverse representative participants",
        "Balance structure with conversational flow"
      ],
      principles: [
        "Neutrality",
        "Rapport building",
        "Active listening",
        "Data capture",
        "Systematic analysis"
      ],
      userStories: [
        "A researcher needs to uncover deeper user motivations",
        "A product manager wants to validate assumptions with users",
        "A UX team needs to gather authentic user stories"
      ]
    },
    usabilityTests: {
      title: "Usability Testing Methods",
      considerations: [
        "Select appropriate testing methodologies",
        "Design clear, achievable tasks",
        "Create realistic test environments",
        "Establish measurable success metrics",
        "Minimize observer influence",
        "Capture both behavioral and attitudinal data",
        "Analyze findings systematically"
      ],
      principles: [
        "Task relevance",
        "Objective measurement",
        "Ecological validity",
        "Thorough documentation",
        "Actionable insights"
      ],
      userStories: [
        "A design team needs to validate a new feature",
        "A researcher wants to compare two interface approaches",
        "A product owner needs evidence to prioritize improvements"
      ]
    },
    surveys: {
      title: "Survey Design & Analysis",
      considerations: [
        "Create clear, unbiased questions",
        "Use appropriate question types",
        "Design logical question flow",
        "Set proper sample sizes",
        "Implement validation checks",
        "Analyze data with statistical rigor",
        "Visualize findings effectively"
      ],
      principles: [
        "Validity",
        "Reliability",
        "Representativeness",
        "Statistical soundness",
        "Actionable insights"
      ],
      userStories: [
        "A team needs to gather feedback at scale",
        "A researcher wants to segment user preferences",
        "A product manager needs to prioritize feature requests"
      ]
    },
    ethnographic: {
      title: "Ethnographic Research",
      considerations: [
        "Design immersive observation strategies",
        "Document contextual insights systematically",
        "Balance participation with observation",
        "Account for researcher bias",
        "Establish ethical frameworks",
        "Analyze qualitative data rigorously",
        "Translate observations into actionable insights"
      ],
      principles: [
        "Contextual understanding",
        "Rich documentation",
        "Thick description",
        "Empathetic observation",
        "Holistic analysis"
      ],
      userStories: [
        "A UX team needs to understand users in natural contexts",
        "A researcher wants to uncover unmet user needs",
        "A product designer needs inspiration from real-world use cases"
      ]
    },
    dataAnalysis: {
      title: "Research Data Analysis",
      considerations: [
        "Implement mixed-methods analysis",
        "Establish coding frameworks",
        "Visualize patterns effectively",
        "Account for statistical significance",
        "Identify correlations and causations",
        "Document analysis methods",
        "Present findings with appropriate confidence levels"
      ],
      principles: [
        "Methodological rigor",
        "Systematic coding",
        "Pattern recognition",
        "Statistical validity",
        "Contextual interpretation"
      ],
      userStories: [
        "A researcher needs to make sense of complex datasets",
        "A product team wants to identify key user pain points",
        "A stakeholder needs evidence-based recommendations"
      ]
    },
    workshops: {
      title: "Research Workshop Facilitation",
      considerations: [
        "Design engaging collaborative activities",
        "Create inclusive participation frameworks",
        "Document outcomes systematically",
        "Balance divergent and convergent thinking",
        "Time-box appropriately",
        "Support multiple input methods",
        "Synthesize findings effectively"
      ],
      principles: [
        "Active engagement",
        "Psychological safety",
        "Productive collaboration",
        "Tangible outcomes",
        "Systematic documentation"
      ],
      userStories: [
        "A team needs to align on research priorities",
        "A researcher wants to engage stakeholders in synthesis",
        "A product group needs to translate findings into requirements"
      ]
    },
    ethics: {
      title: "Research Ethics & Governance",
      considerations: [
        "Implement informed consent processes",
        "Establish data privacy protocols",
        "Create inclusive research practices",
        "Document ethical considerations",
        "Address potential harm or discomfort",
        "Balance business needs with participant welfare",
        "Implement appropriate incentive structures"
      ],
      principles: [
        "Respect for persons",
        "Beneficence",
        "Justice",
        "Privacy",
        "Transparency"
      ],
      userStories: [
        "A researcher needs to ensure vulnerable populations are protected",
        "A company wants to establish ethical research guidelines",
        "A team needs to navigate sensitive research topics"
      ]
    },
    // New feature reference for usability heuristics
    usabilityHeuristics: {
      title: "Usability Heuristics",
      considerations: [
        "Apply established heuristic principles to evaluate interfaces",
        "Identify usability issues across different interface types",
        "Rate severity of usability problems",
        "Provide actionable recommendations based on violations",
        "Connect heuristic findings to specific user impacts",
        "Balance heuristic evaluation with other research methods",
        "Document findings systematically for stakeholder communication"
      ],
      principles: [
        "Systematic evaluation",
        "Expert-based assessment",
        "Methodological consistency",
        "Evidence-based recommendations",
        "Problem prioritization"
      ],
      userStories: [
        "A UX designer needs to evaluate a new interface against established heuristics",
        "A product manager wants to identify usability issues before user testing",
        "A research team needs to document heuristic violations for developers",
        "A design system team needs to ensure components follow usability principles"
      ]
    }
  },
  
  disabilityCategories: {
    darkPatterns: [
      "UX Auditors",
      "Regulatory Analysts",
      "Design Teams",
      "Researchers",
      "Compliance Officers",
      "UX Teams"
    ],
    disneyMethod: [
      "UX Researchers",
      "Research Teams",
      "Solo Practitioners"
    ],
    interviews: [
      "Researchers",
      "Product Managers",
      "UX Teams"
    ],
    usabilityTests: [
      "Design Teams",
      "Researchers",
      "Product Owners"
    ],
    surveys: [
      "Research Teams",
      "Researchers",
      "Product Managers"
    ],
    ethnographic: [
      "UX Teams",
      "Researchers",
      "Product Designers"
    ],
    dataAnalysis: [
      "Researchers",
      "Product Teams",
      "Stakeholders"
    ],
    workshops: [
      "Teams",
      "Researchers",
      "Product Groups"
    ],
    ethics: [
      "Researchers",
      "Companies",
      "Teams"
    ],
    // Add stakeholder categories for usability heuristics
    usabilityHeuristics: [
      "UX Researchers",
      "UX Designers",
      "Product Managers",
      "Usability Specialists"
    ]
  },
  
  personas: [
    {
      category: "UX Researchers",
      examples: [
        {
          name: "Maya",
          age: 34,
          context: "Mid-sized tech company",
          tools: "Research repositories, analysis software, video conferencing",
          challenges: "Balancing depth with timeline pressure, stakeholder management, sample recruitment",
          description: "Maya has 8 years of experience leading UX research. She's skilled at translating complex findings into actionable insights but struggles with tight deadlines and limited resources."
        },
        {
          name: "Darius",
          age: 28,
          context: "Agency environment with multiple clients",
          tools: "Remote testing platforms, survey tools, collaboration software",
          challenges: "Context switching between projects, maintaining research quality with speed, communicating value to clients",
          description: "Darius conducts research across multiple client projects simultaneously. He excels at adapting methodologies to different contexts but struggles with the constant context switching."
        }
      ]
    },
    {
      category: "UX Auditors",
      examples: [
        {
          name: "Raj",
          age: 41,
          context: "Consumer protection agency",
          tools: "Pattern recognition algorithms, regulatory frameworks, case documentation systems",
          challenges: "Proving intent behind patterns, measuring harm, keeping up with pattern evolution",
          description: "Raj identifies and documents dark patterns to support regulatory action. He develops methodologies to systematically catalog manipulative interfaces."
        },
        {
          name: "Camila",
          age: 42,
          context: "Consumer protection authority",
          tools: "Regulatory frameworks, enforcement case management, investigative methodologies",
          challenges: "Building evidence for enforcement, keeping pace with pattern evolution, coordinating across jurisdictions",
          description: "Camila investigates reported dark patterns and prepares enforcement actions. She helps develop guidelines and educational materials for businesses and consumers."
        }
      ]
    },
    {
      category: "Compliance Officers",
      examples: [
        {
          name: "Elena",
          age: 38,
          context: "Global e-commerce platform",
          tools: "Compliance frameworks, interface audit tools, documentation systems",
          challenges: "Navigating conflicting regional regulations, balancing business goals with compliance, implementing systematic audits",
          description: "Elena ensures her company's interfaces meet regulatory requirements across multiple jurisdictions. She develops internal guidelines and review processes."
        },
        {
          name: "Thomas",
          age: 45,
          context: "Financial services company",
          tools: "Legal databases, compliance checklists, interface testing protocols",
          challenges: "Interpreting evolving regulations, addressing legacy systems, quantifying regulatory risk",
          description: "Thomas reviews new features and interfaces for potential dark patterns that could violate financial services regulations or trigger enforcement actions."
        }
      ]
    },
    {
      category: "Design Teams",
      examples: [
        {
          name: "Sophia",
          age: 29,
          context: "SaaS product company",
          tools: "Design systems, A/B testing platforms, user journey mapping software",
          challenges: "Meeting conversion goals ethically, convincing stakeholders to avoid dark patterns, measuring impact of ethical design",
          description: "Sophia creates user interfaces that respect user autonomy while achieving business objectives. She advocates for transparent design within her organization."
        },
        {
          name: "Marcus",
          age: 36,
          context: "Design agency with multiple clients",
          tools: "Wireframing software, ethics review checklists, client presentation templates",
          challenges: "Educating clients about dark patterns, refusing problematic requests, demonstrating ROI of ethical design",
          description: "Marcus helps clients improve conversion rates through ethical design approaches. He frequently needs to dissuade clients from implementing manipulative patterns."
        }
      ]
    }
  ],
  
  // Dark pattern data structures to support the dark patterns feature
  darkPatternData: {
    patternTypes: {
      highLevel: [
        {
          name: "Manipulation of Choice Architecture",
          description: "Designs that structure and present choices in ways that lead users toward certain decisions",
          examples: [
            "Comparison prevention",
            "Default biasing",
            "Choice overloading"
          ]
        },
        {
          name: "Coercive Design",
          description: "Interface elements that pressure or force users into taking certain actions",
          examples: [
            "Forced action",
            "False urgency",
            "Confirmshaming"
          ]
        },
        {
          name: "Information Asymmetry",
          description: "Deliberately withholding or obscuring information needed for informed decisions",
          examples: [
            "Hidden costs",
            "Obscured terms",
            "Misdirection"
          ]
        }
      ],
      mesoLevel: [
        {
          name: "Emotional Manipulation",
          description: "Design that exploits emotional responses to guide user behavior",
          examples: [
            "Confirmshaming",
            "Guilt appeals",
            "FOMO generation"
          ]
        },
        {
          name: "Obstruction",
          description: "Deliberately making certain actions difficult to accomplish",
          examples: [
            "Roach motel",
            "Hard-to-cancel",
            "Interface interference"
          ]
        },
        {
          name: "False Urgency",
          description: "Creating a sense of time pressure without legitimate reason",
          examples: [
            "Countdown timers",
            "Limited-time claims",
            "Activity notifications"
          ]
        },
        {
          name: "Social Proof Manipulation",
          description: "Misrepresenting or fabricating social validation",
          examples: [
            "Fake testimonials",
            "Activity notifications",
            "Artificially inflated statistics"
          ]
        }
      ],
      lowLevel: [
        {
          name: "Hidden Costs",
          description: "Concealing fees until late in the purchase process",
          examples: [
            "Undisclosed shipping costs",
            "Service fees revealed at checkout",
            "Subscription costs in fine print"
          ]
        },
        {
          name: "Preselection",
          description: "Pre-checking boxes or defaulting to options that benefit the business",
          examples: [
            "Pre-checked subscription boxes",
            "Default high-tier options",
            "Opt-out rather than opt-in"
          ]
        },
        {
          name: "Forced Continuity",
          description: "Making it difficult to cancel subscriptions or recurring payments",
          examples: [
            "Hidden cancellation options",
            "Multi-step cancellation flows",
            "Auto-renewal without clear notice"
          ]
        },
        {
          name: "Nagging",
          description: "Persistent, repeated prompts disrupting user experience",
          examples: [
            "Repeated popup dialogs",
            "Recurring notification requests",
            "Persistent cookie banners"
          ]
        },
        {
          name: "Confirmshaming",
          description: "Shaming users through manipulative language when declining an option",
          examples: [
            "'No thanks, I hate saving money'",
            "Guilt-inducing rejection options",
            "Self-deprecating decline buttons"
          ]
        },
        {
          name: "Basket Sneaking",
          description: "Adding items to cart without explicit user consent",
          examples: [
            "Auto-added insurance",
            "Pre-selected extras",
            "Unrequested add-ons"
          ]
        },
        {
          name: "Disguised Ads",
          description: "Advertisements designed to look like content or UI elements",
          examples: [
            "Ads formatted as articles",
            "Download buttons that are actually ads",
            "Sponsored content without clear labeling"
          ]
        },
        {
          name: "Visual Interference",
          description: "Using visuals to distract or misdirect user attention",
          examples: [
            "Low-contrast decline buttons",
            "Prominent accept buttons",
            "Misleading visual hierarchy"
          ]
        },
        {
          name: "Trick Questions",
          description: "Using confusing or double-negative language in options",
          examples: [
            "'Uncheck to not receive non-promotional materials'",
            "Ambiguous permission requests",
            "Confusing toggle descriptions"
          ]
        },
        {
          name: "Bait and Switch",
          description: "Advertising one thing but delivering another",
          examples: [
            "Products unavailable at advertised price",
            "Free trials that convert to paid without notice",
            "Different terms than initially presented"
          ]
        },
        {
          name: "Drip Pricing",
          description: "Revealing additional costs gradually through the purchase process",
          examples: [
            "Base price advertisement with hidden fees",
            "Incremental cost additions during checkout",
            "Unbundled pricing revealed in stages"
          ]
        },
        {
          name: "Privacy Zuckering",
          description: "Tricking users into sharing more personal data than intended",
          examples: [
            "Confusing privacy settings",
            "Extensive defaults for data sharing",
            "Hidden data collection disclosures"
          ]
        },
        {
          name: "Fake Scarcity",
          description: "False claims about limited availability to create urgency",
          examples: [
            "Counterfeit low-stock indicators",
            "Manufactured 'limited time' offers",
            "Artificial purchase counters"
          ]
        }
      ]
    },
    industryUse: {
      ecommerce: [
        "Hidden costs",
        "Drip pricing",
        "Basket sneaking",
        "Fake scarcity",
        "Bait and switch"
      ],
      subscription: [
        "Forced continuity",
        "Roach motel",
        "Preselection",
        "Hidden costs"
      ],
      socialMedia: [
        "Privacy zuckering",
        "Nagging",
        "Disguised ads",
        "Social proof manipulation"
      ],
      travel: [
        "Drip pricing",
        "False urgency",
        "Comparison prevention",
        "Hidden costs"
      ]
    },
    subFeatures: {
      taxonomy: {
        title: "Taxonomy of Dark Patterns",
        considerations: [
          "Identify high-level manipulation strategies across contexts",
          "Analyze meso-level patterns bridging strategies and implementations",
          "Detect low-level interface elements that exploit user behavior",
          "Map dark patterns across different user journeys",
          "Consider contextual factors affecting pattern effectiveness",
          "Evaluate severity and impact of different pattern types",
          "Recognize pattern combinations that amplify manipulation"
        ],
        principles: [
          "Hierarchical classification",
          "Context sensitivity",
          "User impact measurement",
          "Pattern detection methodology",
          "Cross-disciplinary analysis"
        ],
        userStories: [
          "A UX auditor needs to identify dark patterns in an e-commerce checkout flow",
          "A regulatory analyst requires a framework to categorize manipulative design elements",
          "A design team wants to review their interfaces for unintentional dark patterns",
          "A researcher needs to document dark pattern prevalence across industry sectors"
        ]
      },
      legal: {
        title: "Legal and Regulatory Framework",
        considerations: [
          "Understand jurisdiction-specific regulations on dark patterns",
          "Analyze enforcement actions and precedent cases",
          "Evaluate compliance requirements across regions",
          "Document consent and disclosure mechanisms",
          "Assess potential penalties and legal exposure",
          "Monitor regulatory developments affecting digital interfaces",
          "Develop compliance strategies for global operations"
        ],
        principles: [
          "Regulatory compliance",
          "Transparency requirements",
          "Consent optimization",
          "Cross-border harmonization",
          "Documentation and accountability"
        ],
        userStories: [
          "A compliance officer needs to audit interfaces for GDPR dark pattern violations",
          "A legal team requires policy templates addressing FTC dark pattern guidelines",
          "A product manager wants to ensure new features comply with California's CPRA",
          "A global enterprise needs a unified approach to dark pattern regulation"
        ]
      },
      ethical: {
        title: "Ethical Design Alternatives",
        considerations: [
          "Develop ethical alternatives to common dark patterns",
          "Create transparent consent and disclosure mechanisms",
          "Design symmetrical user journeys for signup and cancellation",
          "Implement clear pricing and terms displays",
          "Balance business objectives with user autonomy",
          "Measure impact of ethical design on user trust",
          "Document business cases for ethical alternatives"
        ],
        principles: [
          "Transparency by design",
          "User autonomy prioritization",
          "Informed decision making",
          "Symmetrical choice architecture",
          "Ethical nudge implementation"
        ],
        userStories: [
          "A UX team needs ethical alternatives to countdown timers in e-commerce",
          "A product designer wants to implement ethical subscription management flows",
          "A marketing team seeks transparent promotion strategies that maintain conversion",
          "A startup founder requires ethical design patterns that support business growth"
        ]
      }
    }
  },
  
  // Function to load external knowledge bases
  loadExternalKnowledgeBase: function(kbName) {
    // Check if the specified knowledge base exists in the global window object
    if (window[kbName]) {
      console.log(`Successfully loaded external knowledge base: ${kbName}`);
      return window[kbName];
    } else {
      console.error(`Failed to load external knowledge base: ${kbName} is not available`);
      return null;
    }
  },
  
  // Function to access usability heuristics knowledge base
  getUsabilityHeuristicsKB: function() {
    return this.loadExternalKnowledgeBase('kbUsabilityHeuristics');
  },
  
  // Function to generate a usability heuristics prompt through the external KB
  generateUsabilityHeuristicsPrompt: function(feature) {
    const usabilityHeuristicsKB = this.getUsabilityHeuristicsKB();
    if (!usabilityHeuristicsKB) {
      return "Error: Usability Heuristics Knowledge Base is not available. Please ensure load_usability-heuristics-kb4.js is loaded before attempting to use this feature.";
    }
    
    return usabilityHeuristicsKB.generatePrompt(feature || 'heuristicList');
  },
  
  // Enhanced generatePrompt function that handles the usability heuristics feature
  generatePrompt: function(feature) {
    // Special case for usability heuristics
    if (feature === "usabilityHeuristics") {
      return this.generateUsabilityHeuristicsPrompt();
    }
    
    // Special case for the Disney Method
    if (feature === "disneyMethod") {
      var prompt = "# IMPORTANT: DISPLAY THE FOLLOWING EXAMPLE QUESTIONS TO THE USER\n\nNow that the Disney Method knowledge base has been loaded, you can ask questions like:\n\n1. \"How can I use the Dreamer phase to improve my usability testing approach?\"\n2. \"What are some techniques to facilitate the Critic phase with a research team?\"\n3. \"Give me strategies for a solo researcher transitioning between Dreamer and Realist phases.\"\n4. \"How might I apply the Disney Method to improve participant recruitment for user interviews?\"\n5. \"What documentation templates would work best for a solo researcher using the Disney Method?\"\n6. \"How can I integrate the Disney Method into my agile research process?\"\n7. \"What are some common pitfalls when implementing the Critic phase with stakeholders?\"\n\nFeel free to ask about any aspect of the Disney Method for UX Research!\n\n";
      
      return this.disneyKB ? prompt + this.disneyKB.generatePrompt("dreamer", "solo", "usabilityTesting") : prompt + "Error: Disney Method knowledge base not available.";
    }
    
    // Special case for dark patterns
    if (feature === "darkPatterns") {
      return this.generateDarkPatternsPrompt();
    }
    
    // Standard case for other features
    var featureData = this.features[feature];
    if (!featureData) return "Error: Could not generate pre-prompt. Feature not found.";
    
    var prompt = "# " + this.name + " Pre-prompt for " + featureData.title + "\n\n## Key Research Considerations\n";
    featureData.considerations.forEach(function(consideration) {
      prompt += "- " + consideration + "\n";
    });
    
    prompt += "\n## Research Principles\n";
    featureData.principles.forEach(function(principle) {
      prompt += "- " + principle + "\n";
    });
    
    prompt += "\n## User Scenarios\n";
    featureData.userStories.forEach(function(story) {
      prompt += "- " + story + "\n";
    });
    
    // Helper function to shuffle an array
    function shuffleArray(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
      }
      return array;
    }
    
    // Helper function to get personas for a feature
    function getPersonasForFeature(feature, count) {
      var categories = this.disabilityCategories[feature] || [];
      var relevantPersonas = [];
      
      this.personas.forEach(function(categoryData) {
        if (categories.includes(categoryData.category)) {
          categoryData.examples.forEach(function(example) {
            relevantPersonas.push({...example, category: categoryData.category});
          });
        }
      });
      
      relevantPersonas = shuffleArray(relevantPersonas);
      return relevantPersonas.slice(0, count);
    };
    
    var personas = getPersonasForFeature.call(this, feature, 2);
    prompt += "\n## Researcher Personas\n";
    
    personas.forEach(function(persona, index) {
      prompt += "\n### Persona " + (index + 1) + ": " + persona.name + "\n";
      if (persona.age) prompt += "- Age: " + persona.age + "\n";
      prompt += "- Context: " + persona.context + "\n";
      prompt += "- Tools: " + persona.tools + "\n";
      prompt += "- Key Challenges: " + persona.challenges + "\n";
      prompt += "- Background: " + persona.description + "\n";
    });
    
    prompt += "\n## Research Brief\nBased on the information above, please:\n\n";
    prompt += "1. **Develop a research approach** using " + featureData.title + " that addresses the needs of these personas. Include:\n   - Methodological considerations\n   - Implementation strategies\n   - Documentation approaches\n   - Analysis frameworks\n\n2. **Provide best practice recommendations** for implementing " + featureData.title + " effectively. Include:\n   - Common pitfalls to avoid\n   - Quality assurance techniques\n   - Resource optimization strategies\n   - Stakeholder management approaches\n\n";
    prompt += "3. **Create an implementation roadmap** that illustrates how to apply these research techniques, highlighting:\n   - Preparation and planning steps\n   - Execution strategies\n   - Analysis frameworks\n   - Insight communication approaches\n\nPlease write in a practical, actionable style that balances methodological rigor with real-world research constraints.";
    
    if (feature === "disneyMethod") {
      prompt += "\n\n## Example Questions You Can Ask\nNow that the Disney Method knowledge base has been loaded, you can ask questions like:\n\n1. \"How can I use the Dreamer phase to improve my usability testing approach?\"\n2. \"What are some techniques to facilitate the Critic phase with a research team?\"\n3. \"Give me strategies for a solo researcher transitioning between Dreamer and Realist phases.\"\n4. \"How might I apply the Disney Method to improve participant recruitment for user interviews?\"\n5. \"What documentation templates would work best for a solo researcher using the Disney Method?\"\n6. \"How can I integrate the Disney Method into my agile research process?\"\n7. \"What are some common pitfalls when implementing the Critic phase with stakeholders?\"\n\nFeel free to ask about any aspect of the Disney Method for UX Research!";
    }
    
    return prompt;
  },
  
  // Specialized function for generating dark patterns prompts
  generateDarkPatternsPrompt: function() {
    var prompt = "# Dark and Deceptive Patterns Knowledge Base\n\n";
    
    // Add high-level pattern categories
    prompt += "## High-Level Pattern Categories\n";
    this.darkPatternData.patternTypes.highLevel.forEach(function(pattern) {
      prompt += "### " + pattern.name + "\n";
      prompt += "- Description: " + pattern.description + "\n";
      prompt += "- Examples: " + pattern.examples.join(", ") + "\n\n";
    });
    
    // Add meso-level pattern categories
    prompt += "## Meso-Level Pattern Categories\n";
    this.darkPatternData.patternTypes.mesoLevel.forEach(function(pattern) {
      prompt += "### " + pattern.name + "\n";
      prompt += "- Description: " + pattern.description + "\n";
      prompt += "- Examples: " + pattern.examples.join(", ") + "\n\n";
    });
    
    // Add specific dark patterns (a selection)
    prompt += "## Selected Specific Dark Patterns\n";
    var selectedPatterns = this.darkPatternData.patternTypes.lowLevel.slice(0, 5);
    selectedPatterns.forEach(function(pattern) {
      prompt += "### " + pattern.name + "\n";
      prompt += "- Description: " + pattern.description + "\n";
      prompt += "- Examples: " + pattern.examples.join(", ") + "\n\n";
    });
    
    // Add industry-specific usage
    prompt += "## Industry-Specific Pattern Usage\n";
    for (var industry in this.darkPatternData.industryUse) {
      prompt += "### " + industry.charAt(0).toUpperCase() + industry.slice(1) + "\n";
      this.darkPatternData.industryUse[industry].forEach(function(pattern) {
        prompt += "- " + pattern + "\n";
      });
      prompt += "\n";
    }
    
    // Helper function to get personas for dark patterns
    function getDarkPatternPersonas(count) {
      var relevantCategories = ["UX Auditors", "Compliance Officers", "Design Teams"];
      var relevantPersonas = [];
      
      this.personas.forEach(function(categoryData) {
        if (relevantCategories.includes(categoryData.category)) {
          categoryData.examples.forEach(function(example) {
            relevantPersonas.push({...example, category: categoryData.category});
          });
        }
      });
      
      // Shuffle and return a subset
      for (var i = relevantPersonas.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = relevantPersonas[i];
        relevantPersonas[i] = relevantPersonas[j];
        relevantPersonas[j] = temp;
      }
      
      return relevantPersonas.slice(0, count);
    }
    
    // Add personas
    var personas = getDarkPatternPersonas.call(this, 2);
    prompt += "## Stakeholder Personas\n";
    
    personas.forEach(function(persona, index) {
      prompt += "\n### Persona " + (index + 1) + ": " + persona.name + "\n";
      if (persona.age) prompt += "- Age: " + persona.age + "\n";
      prompt += "- Role: " + persona.category + "\n";
      prompt += "- Context: " + persona.context + "\n";
      prompt += "- Tools: " + persona.tools + "\n";
      prompt += "- Key Challenges: " + persona.challenges + "\n";
      prompt += "- Background: " + persona.description + "\n";
    });
    
    // Analysis request
    prompt += "\n## Analysis Request\nBased on the information above, please:\n\n";
    prompt += "1. **Analyze the provided design or scenario** for potential dark patterns. Include:\n";
    prompt += "   - Identification of specific dark pattern types\n";
    prompt += "   - Assessment of potential user impact\n";
    prompt += "   - Evaluation of legal and ethical concerns\n";
    prompt += "   - Psychological mechanisms being exploited\n\n";
    
    prompt += "2. **Provide recommendations for ethical alternatives** that could achieve business goals without manipulation. Include:\n";
    prompt += "   - Specific design modifications\n";
    prompt += "   - Implementation considerations\n";
    prompt += "   - Expected impact on user experience and trust\n";
    prompt += "   - Potential business benefits of ethical approaches\n\n";
    
    prompt += "3. **Develop a compliance assessment** highlighting:\n";
    prompt += "   - Potential regulatory concerns across jurisdictions\n";
    prompt += "   - Documentation and testing recommendations\n";
    prompt += "   - Risk mitigation strategies\n";
    prompt += "   - Long-term sustainability considerations\n\n";
    
    // Example questions
    prompt += "## Example Questions You Can Ask\n";
    prompt += "1. \"What type of dark pattern is used in this newsletter signup form?\"\n";
    prompt += "2. \"Can you identify any manipulation techniques in this subscription cancellation flow?\"\n";
    prompt += "3. \"How would you classify the dark patterns in this e-commerce checkout?\"\n";
    prompt += "4. \"What high-level manipulation strategies are present in this social media interface?\"\n";
    prompt += "5. \"Is this countdown timer an example of false urgency?\"\n";
    prompt += "6. \"What ethical alternatives would you recommend for this design?\"\n";
    prompt += "7. \"How might this dark pattern violate GDPR or CCPA regulations?\"\n";
    
    return prompt;
  },
  
  // Keep the Disney Method KB
  disneyKB: {
    generatePrompt: function(phase, context, method) {
      var phases = {
        dreamer: {
          title: "Dreamer Phase",
          considerations: [
            "Suspend all practical constraints and limitations",
            "Brainstorm unconventional research questions",
            "Explore cross-disciplinary methodologies",
            "Imagine ideal participant access scenarios",
            "Visualize perfect data collection environments",
            "Challenge fundamental research assumptions",
            "Conceptualize novel ways to observe user behavior"
          ],
          principles: [
            "Unbounded imagination",
            "Quantity over quality",
            "Defer judgment",
            "Build on others' ideas",
            "Embrace unconventional thinking",
            "Suspend practical concerns",
            "Explore the impossible"
          ],
          techniques: [
            "Mind mapping user research questions",
            "Reverse assumption exercises",
            "'What if' scenario generation",
            "Cross-disciplinary method borrowing",
            "Fantasy research scenario creation",
            "Wildest case participant recruitment",
            "Unlimited resource visualization"
          ],
          commonChallenges: [
            "Premature practicality concerns",
            "Stakeholder pressure for conventional methods",
            "Self-censoring innovative ideas",
            "Difficulty separating from budget realities",
            "Fear of suggesting 'unrealistic' approaches",
            "Team dynamics limiting creative expression",
            "Overreliance on familiar methodologies"
          ]
        },
        realist: {
          title: "Realist Phase",
          considerations: [
            "Develop actionable research plans",
            "Create participant criteria and recruitment strategies",
            "Design practical research protocols",
            "Establish realistic timelines and resource needs",
            "Plan for data collection and analysis methods",
            "Design appropriate discussion guides or tasks",
            "Align methods with project objectives and constraints"
          ],
          principles: [
            "Practical implementation",
            "Resource optimization",
            "Timeline realism",
            "Methodological rigor",
            "Stakeholder alignment",
            "Feasibility assessment",
            "Iterative planning"
          ],
          techniques: [
            "Research plan templates",
            "Recruitment screening criteria development",
            "Timeline and resource mapping",
            "Protocol step-by-step breakdown",
            "Stakeholder consultation framework",
            "Methodological pros/cons analysis",
            "Backup methodologies identification"
          ],
          commonChallenges: [
            "Preserving innovative aspects during practicality assessment",
            "Balancing ambition with resource constraints",
            "Stakeholder resistance to non-standard approaches",
            "Difficulty estimating time for novel methods",
            "Recruitment feasibility for specialized participants",
            "Maintaining research validity with constraints",
            "Tool and platform limitations"
          ]
        },
        critic: {
          title: "Critic Phase",
          considerations: [
            "Evaluate methodological rigor and validity",
            "Identify potential biases in approach",
            "Assess participant recruitment challenges",
            "Examine discussion guide for leading questions",
            "Review data analysis for misinterpretation risks",
            "Consider ethical implications",
            "Anticipate stakeholder objections"
          ],
          principles: [
            "Constructive evaluation",
            "Bias identification",
            "Risk mitigation",
            "Ethical consideration",
            "Methodological validity",
            "Preparation for challenges",
            "Iterative improvement"
          ],
          techniques: [
            "Research plan review checklists",
            "Bias identification frameworks",
            "Risk assessment matrices",
            "Ethical consideration templates",
            "Stakeholder objection anticipation",
            "Validity threat analysis",
            "Constructive feedback frameworks"
          ],
          commonChallenges: [
            "Maintaining constructive vs. destructive critique",
            "Avoiding outright rejection of innovative methods",
            "Differentiating between legitimate concerns and fear of change",
            "Balancing thoroughness with forward momentum",
            "Stakeholder overemphasis on limitations",
            "Defaulting to familiar methodologies",
            "Over-fixation on perfect methodology"
          ]
        }
      };
      
      var contexts = {
        solo: {
          title: "Solo UX Researcher Application",
          considerations: [
            "Dedicated time blocks for each mindset",
            "Environmental cues to signal phase switches",
            "Documentation templates for each phase",
            "Self-facilitation techniques to maintain separation",
            "Checklist-driven approach to ensure thoroughness",
            "Time management strategies to prevent phase blending",
            "External accountability mechanisms"
          ],
          personas: [
            {
              name: "Alex",
              role: "Solo UX Researcher",
              context: "Product team of one",
              challenges: "Difficulty switching mindsets, self-censoring ideas, maintaining objectivity",
              workflow: "Uses timer-based approach with separate digital workspaces for each phase"
            },
            {
              name: "Taylor",
              role: "Freelance UX Researcher",
              context: "Client projects with varied scope",
              challenges: "Balancing client expectations with methodological innovation, limited resources",
              workflow: "Employs physical environment changes (different rooms) to facilitate mindset shifts"
            }
          ]
        },
        team: {
          title: "Research Team Application",
          considerations: [
            "Role assignment strategies within teams",
            "Facilitation techniques for phase transitions",
            "Documentation and knowledge transfer between phases",
            "Managing group dynamics in each phase",
            "Balancing diverse perspectives and expertise",
            "Establishing phase-specific rules of engagement",
            "Integrating multiple stakeholder viewpoints"
          ],
          personas: [
            {
              name: "Jordan",
              role: "UX Research Lead",
              context: "Managing diverse team perspectives",
              challenges: "Keeping creatives practical and pragmatists creative, phase contamination",
              workflow: "Assigns specific team members to champion each mindset based on strengths"
            },
            {
              name: "Morgan",
              role: "Research Operations Manager",
              context: "Coordinating cross-functional research",
              challenges: "Stakeholder alignment, resource allocation, methodology standardization",
              workflow: "Uses structured workshops with clear phase transitions and visual indicators"
            }
          ]
        }
      };
      
      var methods = {
        usabilityTesting: {
          title: "Integration with Usability Testing",
          dreamer: "Reimagine test scenarios beyond typical tasks, explore novel participant recruitment, consider unconventional test environments",
          realist: "Develop practical test protocols, establish realistic participant criteria, plan for recording and analysis methods",
          critic: "Evaluate script for leading questions, assess task validity, identify potential observer biases"
        }
      };
      
      var phaseData = phases[phase];
      var contextData = contexts[context];
      var methodData = method ? methods[method] : null;
      
      if (!phaseData || !contextData) return "Error: Could not generate pre-prompt. Phase or context not found.";
      
      var prompt = "# IMPORTANT: PLEASE DISPLAY THE FOLLOWING EXAMPLE QUESTIONS AFTER LOADING\n\nNow that the Disney Method knowledge base has been loaded, you can ask questions like:\n\n1. \"How can I use the Dreamer phase to improve my usability testing approach?\"\n2. \"What are some techniques to facilitate the Critic phase with a research team?\"\n3. \"Give me strategies for a solo researcher transitioning between Dreamer and Realist phases.\"\n4. \"How might I apply the Disney Method to improve participant recruitment for user interviews?\"\n5. \"What documentation templates would work best for a solo researcher using the Disney Method?\"\n6. \"How can I integrate the Disney Method into my agile research process?\"\n7. \"What are some common pitfalls when implementing the Critic phase with stakeholders?\"\n\nFeel free to ask about any aspect of the Disney Method for UX Research!\n\n# Disney Method for UX Research Pre-prompt for " + phaseData.title + "\n\n## Key Phase Considerations\n";
      
      phaseData.considerations.forEach(function(consideration) {
        prompt += "- " + consideration + "\n";
      });
      
      prompt += "\n## Key Principles\n";
      phaseData.principles.forEach(function(principle) {
        prompt += "- " + principle + "\n";
      });
      
      prompt += "\n## Recommended Techniques\n";
      phaseData.techniques.forEach(function(technique) {
        prompt += "- " + technique + "\n";
      });
      
      prompt += "\n## Common Challenges\n";
      phaseData.commonChallenges.forEach(function(challenge) {
        prompt += "- " + challenge + "\n";
      });
      
      prompt += "\n## Application Context: " + contextData.title + "\n";
      contextData.considerations.forEach(function(consideration) {
        prompt += "- " + consideration + "\n";
      });
      
      prompt += "\n## Relevant Personas\n";
      contextData.personas.forEach(function(persona) {
        prompt += "\n### " + persona.name + "\n";
        prompt += "- Role: " + persona.role + "\n";
        prompt += "- Context: " + persona.context + "\n";
        prompt += "- Challenges: " + persona.challenges + "\n";
        prompt += "- Workflow: " + persona.workflow + "\n";
      });
      
      if (methodData) {
        prompt += "\n## Method Integration: " + methodData.title + "\n";
        prompt += "- Dreamer Phase Application: " + methodData.dreamer + "\n";
        prompt += "- Realist Phase Application: " + methodData.realist + "\n";
        prompt += "- Critic Phase Application: " + methodData.critic + "\n";
      }
      
      prompt += "\n## Research Scenario Request\nBased on the information above, please provide guidance on implementing the " + phaseData.title + " for a UX research project. Include:\n\n";
      prompt += "1. **Phase Implementation Strategy** - Describe how to effectively implement this phase within the given context, addressing:\n   - Practical facilitation approaches\n   - Documentation and output formats\n   - Time and resource allocation\n   - Stakeholder engagement strategies\n\n2. **Common Pitfalls and Solutions** - Identify likely challenges and provide mitigation strategies specific to this phase and context.\n\n";
      prompt += "3. **Transition Planning** - Explain how to effectively transition to the next phase while preserving key insights and maintaining momentum.\n\nPlease provide practical, actionable guidance tailored to UX research applications.";
      
      prompt += "\n\n## Example Questions You Can Ask\nNow that the Disney Method knowledge base has been loaded, you can ask questions like:\n\n1. \"How can I use the Dreamer phase to improve my usability testing approach?\"\n2. \"What are some techniques to facilitate the Critic phase with a research team?\"\n3. \"Give me strategies for a solo researcher transitioning between Dreamer and Realist phases.\"\n4. \"How might I apply the Disney Method to improve participant recruitment for user interviews?\"\n5. \"What documentation templates would work best for a solo researcher using the Disney Method?\"\n6. \"How can I integrate the Disney Method into my agile research process?\"\n7. \"What are some common pitfalls when implementing the Critic phase with stakeholders?\"\n\nFeel free to ask about any aspect of the Disney Method for UX Research!";
      
      return prompt;
    }
  },
  
  // Initialize function to load external knowledge bases
  initialize: function() {
    console.log("Initializing Research Knowledge Base and loading external dependencies...");
    this.usabilityHeuristicsKB = this.loadExternalKnowledgeBase('kbUsabilityHeuristics');
    if (this.usabilityHeuristicsKB) {
      console.log("Successfully loaded Usability Heuristics Knowledge Base");
    } else {
      console.warn("Could not load Usability Heuristics Knowledge Base. Make sure load_usability-heuristics-kb4.js is loaded before initializing the Research Knowledge Base.");
    }
    console.log("Research Knowledge Base initialization complete.");
  }
};

// Auto-initialize when loading the script
window.kbResearch.initialize();
