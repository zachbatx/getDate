(function(){if(document.getElementById('llmPrimer-panel')){const panel=document.getElementById('llmPrimer-panel');panel.style.display=panel.style.display==='none'?'block':'none';return}const kbLoaderScript=document.createElement('script');kbLoaderScript.src='https://path-to-your-script/llmPrimer_bkm_kbLoader_v1.0.js';document.head.appendChild(kbLoaderScript);const mammothScript=document.createElement('script');mammothScript.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js';document.head.appendChild(mammothScript);const turndownScript=document.createElement('script');turndownScript.src='https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.1/turndown.min.js';document.head.appendChild(turndownScript);kbLoaderScript.onload=function(){try{const panel=document.createElement('div');panel.id='llmPrimer-panel';panel.style.cssText='position:fixed;top:20px;right:20px;width:300px;background-color:#ffffff;border:1px solid #cccccc;border-radius:5px;padding:15px;box-shadow:0 4px 8px rgba(0, 0, 0, 0.1);zIndex:10000;font-family:Arial, sans-serif;font-size:14px;color:#333333;';const headerDiv=document.createElement('div');headerDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;';const title=document.createElement('h3');title.textContent='llmPrimer';title.style.cssText='margin:0;font-size:16px;font-weight:bold;';headerDiv.appendChild(title);const buttonGroup=document.createElement('div');buttonGroup.style.cssText='display:flex;gap:5px;';const themeBtn=document.createElement('button');themeBtn.id='llmPrimer-theme-btn';themeBtn.innerText='ðŸŒ“';themeBtn.title='Toggle theme';themeBtn.style.cssText='border:none;background:none;cursor:pointer;fontSize:16px;';themeBtn.addEventListener('click',toggleTheme);buttonGroup.appendChild(themeBtn);const toggleBtn=document.createElement('button');toggleBtn.id='llmPrimer-toggle-btn';toggleBtn.innerText='âš¡';toggleBtn.title='Toggle panel';toggleBtn.style.cssText='border:none;background:none;cursor:pointer;fontSize:16px;';toggleBtn.addEventListener('click',minimizePanel);buttonGroup.appendChild(toggleBtn);const closeBtn=document.createElement('button');closeBtn.id='llmPrimer-close-btn';closeBtn.innerText='âœ•';closeBtn.title='Close panel';closeBtn.style.cssText='border:none;background:none;cursor:pointer;fontSize:16px;';closeBtn.addEventListener('click',closePanel);buttonGroup.appendChild(closeBtn);headerDiv.appendChild(buttonGroup);panel.appendChild(headerDiv);const categoryLabel=document.createElement('label');categoryLabel.textContent='Select Category:';categoryLabel.style.cssText='display:block;margin-bottom:5px;font-size:14px;';panel.appendChild(categoryLabel);const categorySelect=document.createElement('select');categorySelect.className='categorySelect';categorySelect.style.cssText='width:100%;padding:5px;margin-bottom:15px;border-radius:3px;border:1px solid #ccc;';const defaultCategoryOption=document.createElement('option');defaultCategoryOption.value='';defaultCategoryOption.textContent='-- Select a category --';categorySelect.appendChild(defaultCategoryOption);if(typeof kbCategory==='undefined'||!Array.isArray(kbCategory)){throw new Error('Knowledge base categories not found or invalid')}kbCategory.forEach(category=>{const option=document.createElement('option');option.value=category.id;option.textContent=category.title;categorySelect.appendChild(option)});panel.appendChild(categorySelect);const kbLabel=document.createElement('label');kbLabel.textContent='Select Knowledge Base:';kbLabel.style.cssText='display:block;margin-bottom:5px;font-size:14px;';panel.appendChild(kbLabel);const kbSelect=document.createElement('select');kbSelect.className='knowledgeBaseSelect';kbSelect.style.cssText='width:100%;padding:5px;margin-bottom:15px;border-radius:3px;border:1px solid #ccc;';kbSelect.disabled=true;const defaultKBOption=document.createElement('option');defaultKBOption.value='';defaultKBOption.textContent='-- Select a knowledge base --';kbSelect.appendChild(defaultKBOption);panel.appendChild(kbSelect);const actionDiv=document.createElement('div');actionDiv.style.cssText='display:flex;justify-content:space-between;gap:10px;';const injectBtn=document.createElement('button');injectBtn.id='llmPrimer-inject-btn';injectBtn.innerText='Inject Prompt';injectBtn.style.cssText='padding:8px 15px;border-radius:3px;border:1px solid #ccc;background-color:#f0f0f0;cursor:pointer;flex:1;';injectBtn.disabled=true;injectBtn.addEventListener('click',injectPrompt);actionDiv.appendChild(injectBtn);const copyBtn=document.createElement('button');copyBtn.id='llmPrimer-copy-btn';copyBtn.innerText='Copy Prompt';copyBtn.style.cssText='padding:8px 15px;border-radius:3px;border:1px solid #ccc;background-color:#f0f0f0;cursor:pointer;flex:1;';copyBtn.disabled=true;copyBtn.addEventListener('click',copyPrompt);actionDiv.appendChild(copyBtn);panel.appendChild(actionDiv);document.body.appendChild(panel);categorySelect.addEventListener('change',function(){populateKnowledgeBases(this.value);kbSelect.disabled=!this.value;injectBtn.disabled=true;copyBtn.disabled=true});kbSelect.addEventListener('change',function(){injectBtn.disabled=!this.value;copyBtn.disabled=!this.value});if(typeof kbDomain==='undefined'||!Array.isArray(kbDomain)){throw new Error('Knowledge base domains not found or invalid')}if(kbCategory.length>0){categorySelect.value=kbCategory[0].id;populateKnowledgeBases(kbCategory[0].id);kbSelect.disabled=false}applyCurrentTheme()}catch(error){console.error('Error initializing llmPrimer:',error);alert('Failed to initialize llmPrimer: '+error.message)}};kbLoaderScript.onerror=function(){alert('Failed to load knowledge base data. Please check your network connection and try again.')};function populateKnowledgeBases(categoryId){try{const kbSelect=document.querySelector('.knowledgeBaseSelect');if(!kbSelect){throw new Error('Knowledge base select element not found')}while(kbSelect.options.length>1){kbSelect.remove(1)}const filteredDomains=kbDomain.filter(domain=>domain.category===categoryId);filteredDomains.forEach(domain=>{const option=document.createElement('option');option.value=domain.id;option.textContent=domain.title;kbSelect.appendChild(option)});if(filteredDomains.length>0){kbSelect.value=filteredDomains[0].id;const injectButton=document.getElementById('llmPrimer-inject-btn');const copyButton=document.getElementById('llmPrimer-copy-btn');if(injectButton&Â©Button){injectButton.disabled=false;copyButton.disabled=false}}}catch(error){console.error('Error populating knowledge bases:',error);alert('Failed to populate knowledge bases: '+error.message)}}async function G(){try{const kbSelect=document.querySelector('.knowledgeBaseSelect');if(!kbSelect){throw new Error('Knowledge base select element not found')}const selectedKbId=kbSelect.value;if(!selectedKbId){return''}const selectedKb=kbDomain.find(kb=>kb.id===selectedKbId);if(!selectedKb||!selectedKb.docxUrl){return''}try{const markdown=await processDocxToMarkdown(selectedKb.docxUrl);return markdown}catch(conversionError){console.error('Error during DOCX to Markdown conversion:',conversionError);showAlert("Error converting DOCX file to Markdown.","error");return ''}}catch(error){console.error('Error getting DOCX URL or processing:',error);return ''}}function R(){console.log('Prompt injected successfully')}async function injectPrompt(){I()}async function I(){try{const markdownPrompt=await G();if(!markdownPrompt){showAlert('No valid knowledge base selected or error converting to Markdown.','error');return}const promptTextAreaPlaceholder=document.querySelector("div#prompt-textarea p.placeholder");if(!promptTextAreaPlaceholder){showAlert("Target placeholder not found! Please ensure you're on a compatible LLM interface.","error");return}promptTextAreaPlaceholder.innerText=markdownPrompt;promptTextAreaPlaceholder.dispatchEvent(new Event("input",{bubbles:true}));setTimeout(()=>{const sendButton=document.querySelector('button[data-testid="send-button"]');if(sendButton){sendButton.click();R()}else{showAlert("Send button not found! Markdown text was inserted but could not be sent automatically.","warning")}},100)}catch(error){console.error('Error injecting prompt:',error);showAlert('Failed to inject prompt: '+error.message,'error')}}async function copyPrompt(){try{const markdownPrompt=await G();if(!markdownPrompt){showAlert('No knowledge base selected or error converting to Markdown!','error');return}if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(markdownPrompt).then(()=>{const copyButton=document.getElementById('llmPrimer-copy-btn');if(copyButton){const originalText=copyButton.innerText;copyButton.innerText='âœ“ Copied!';setTimeout(()=>{copyButton.innerText=originalText},2000)}else{alert('Markdown content copied to clipboard!')}}).catch(error=>{console.error('Clipboard error:',error);showAlert('Failed to copy: '+error.message,'error')})}else{const textarea=document.createElement('textarea');textarea.value=markdownPrompt;textarea.style.cssText='position:fixed;left:-999999px;top:-999999px;';document.body.appendChild(textarea);textarea.focus();textarea.select();let success=false;try{success=document.execCommand('copy')}catch(err){console.error('Fallback clipboard error:',err)}document.body.removeChild(textarea);if(success){const copyButton=document.getElementById('llmPrimer-copy-btn');if(copyButton){const originalText=copyButton.innerText;copyButton.innerText='âœ“ Copied!';setTimeout(()=>{copyButton.innerText=originalText},2000)}else{alert('Markdown content copied to clipboard!')}}else{showAlert('Failed to copy. Please select and copy manually: '+markdownPrompt,'warning')}}}catch(error){console.error('Error copying to clipboard:',error);showAlert('Failed to copy: '+error.message,'error')}}function toggleTheme(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found')}const isDarkTheme=panel.getAttribute('data-theme')==='dark';if(isDarkTheme){setLightTheme(panel)}else{setDarkTheme(panel)}localStorage.setItem('llmPrimer-theme',isDarkTheme?'light':'dark')}catch(error){console.error('Error toggling theme:',error)}}function applyCurrentTheme(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found')}const currentTheme=localStorage.getItem('llmPrimer-theme')||'light';if(currentTheme==='dark'){setDarkTheme(panel)}else{setLightTheme(panel)} }catch(error){console.error('Error applying theme:',error)}}function minimizePanel(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found')}const panelChildren=Array.from(panel.children).slice(1);const isMinimized=panel.getAttribute('data-minimized')==='true';if(isMinimized){panelChildren.forEach(child=>{child.style.display=''});panel.setAttribute('data-minimized','false')}else{panelChildren.forEach(child=>{child.style.display='none'});panel.setAttribute('data-minimized','true')}}catch(error){console.error('Error toggling panel:',error)}}function closePanel(){try{const panel=document.getElementById('llmPrimer-panel');if(panel){panel.remove()}}catch(error){console.error('Error closing panel:',error)}}function setDarkTheme(panel){panel.setAttribute('data-theme','dark');panel.style.cssText='background-color:#333333;color:#ffffff;border:1px solid #555555;';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(btn=>{btn.style.cssText='background-color:#444444;color:#ffffff;border:1px solid #666666;'});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.cssText='background-color:#444444;color:#ffffff;border:1px solid #666666;'})}function setLightTheme(panel){panel.setAttribute('data-theme','light');panel.style.cssText='background-color:#ffffff;color:#333333;border:1px solid #cccccc;';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(btn=>{btn.style.cssText='background-color:#f0f0f0;color:#333333;border:1px solid #cccccc;'});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.cssText='background-color:#ffffff;color:#333333;border:1px solid #cccccc;'})}function showAlert(message,type){let prefix="";if(type==="success")prefix="Success: ";else if(type==="error")prefix="Error: ";else if(type==="warning")prefix="Warning: ";alert(prefix+message)}function formatBytes(bytes,decimals=2){if(bytes===0)return'0 Bytes';const k=1024,dm=decimals<0?0:decimals,sizes=['Bytes','KB','MB','GB','TB'],i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]}async function processDocxToMarkdown(docxUrl){try{if(typeof mammoth==='undefined'||typeof TurndownService==='undefined'){throw new Error('mammoth.js or turndown.js not loaded properly.')}const response=await fetch(docxUrl);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}const arrayBuffer=await response.arrayBuffer();const mammothResult=await mammoth.convertToHtml({arrayBuffer:arrayBuffer});const html=mammothResult.value;const turndownService=new TurndownService();const markdownContent=turndownService.turndown(html);return markdownContent}catch(error){console.error("Error processing DOCX file:",error);throw error}}})();