(function(){if(document.getElementById('llmPrimer-panel')){const panel=document.getElementById('llmPrimer-panel');panel.style.display=panel.style.display==='none'?'block':'none';return;}loadDependencies().then(initializePanel).catch(error=>{console.error('Failed to load dependencies:',error);alert('Failed to load dependencies. Please check your network connection and try again.');});function loadDependencies(){return new Promise((resolve,reject)=>{const kbScript=document.createElement('script');kbScript.src='https://path-to-your-script/llmPrimer_bkm_kbLoader_v1.0.js';document.head.appendChild(kbScript);let mammothLoaded=typeof mammoth!=='undefined';let turndownLoaded=typeof TurndownService!=='undefined';if(!mammothLoaded){const mammothScript=document.createElement('script');mammothScript.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js';document.head.appendChild(mammothScript);mammothScript.onload=()=>{mammothLoaded=true;checkAllLoaded();};mammothScript.onerror=reject;}if(!turndownLoaded){const turndownScript=document.createElement('script');turndownScript.src='https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.1/turndown.min.js';document.head.appendChild(turndownScript);turndownScript.onload=()=>{turndownLoaded=true;checkAllLoaded();};turndownScript.onerror=reject;}kbScript.onload=()=>{checkAllLoaded();};kbScript.onerror=reject;function checkAllLoaded(){if((mammothLoaded||typeof mammoth!=='undefined')&&(turndownLoaded||typeof TurndownService!=='undefined')&&typeof kbCategory!=='undefined'&&typeof kbDomain!=='undefined'){resolve();}}setTimeout(()=>{if(typeof kbCategory!=='undefined'&&typeof kbDomain!=='undefined'){if((mammothLoaded||typeof mammoth!=='undefined')&&(turndownLoaded||typeof TurndownService!=='undefined')){resolve();}}},1000);});}function initializePanel(){try{const panel=document.createElement('div');panel.id='llmPrimer-panel';panel.style.position='fixed';panel.style.top='20px';panel.style.right='20px';panel.style.width='300px';panel.style.backgroundColor='#ffffff';panel.style.border='1px solid #cccccc';panel.style.borderRadius='5px';panel.style.padding='15px';panel.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.1)';panel.style.zIndex='10000';panel.style.fontFamily='Arial, sans-serif';panel.style.fontSize='14px';panel.style.color='#333333';const header=document.createElement('div');header.style.display='flex';header.style.justifyContent='space-between';header.style.alignItems='center';header.style.marginBottom='15px';const title=document.createElement('h3');title.textContent='llmPrimer';title.style.margin='0';title.style.fontSize='16px';title.style.fontWeight='bold';header.appendChild(title);const controls=document.createElement('div');controls.style.display='flex';controls.style.gap='5px';const themeBtn=document.createElement('button');themeBtn.id='llmPrimer-theme-btn';themeBtn.innerText='ðŸŒ“';themeBtn.title='Toggle theme';themeBtn.style.border='none';themeBtn.style.background='none';themeBtn.style.cursor='pointer';themeBtn.style.fontSize='16px';themeBtn.addEventListener('click',toggleTheme);controls.appendChild(themeBtn);const toggleBtn=document.createElement('button');toggleBtn.id='llmPrimer-toggle-btn';toggleBtn.innerText='âš¡';toggleBtn.title='Toggle panel';toggleBtn.style.border='none';toggleBtn.style.background='none';toggleBtn.style.cursor='pointer';toggleBtn.style.fontSize='16px';toggleBtn.addEventListener('click',minimizePanel);controls.appendChild(toggleBtn);const closeBtn=document.createElement('button');closeBtn.id='llmPrimer-close-btn';closeBtn.innerText='âœ•';closeBtn.title='Close panel';closeBtn.style.border='none';closeBtn.style.background='none';closeBtn.style.cursor='pointer';closeBtn.style.fontSize='16px';closeBtn.addEventListener('click',closePanel);controls.appendChild(closeBtn);header.appendChild(controls);panel.appendChild(header);const categoryLabel=document.createElement('label');categoryLabel.textContent='Select Category:';categoryLabel.style.display='block';categoryLabel.style.marginBottom='5px';categoryLabel.style.fontSize='14px';panel.appendChild(categoryLabel);const categorySelect=document.createElement('select');categorySelect.className='categorySelect';categorySelect.style.width='100%';categorySelect.style.padding='5px';categorySelect.style.marginBottom='15px';categorySelect.style.borderRadius='3px';categorySelect.style.border='1px solid #ccc';const defaultOption=document.createElement('option');defaultOption.value='';defaultOption.textContent='-- Select a category --';categorySelect.appendChild(defaultOption);if(typeof kbCategory==='undefined'||!Array.isArray(kbCategory)){throw new Error('Knowledge base categories not found or invalid');}kbCategory.forEach(category=>{const option=document.createElement('option');option.value=category.id;option.textContent=category.title;categorySelect.appendChild(option);});panel.appendChild(categorySelect);const kbLabel=document.createElement('label');kbLabel.textContent='Select Knowledge Base:';kbLabel.style.display='block';kbLabel.style.marginBottom='5px';kbLabel.style.fontSize='14px';panel.appendChild(kbLabel);const kbSelect=document.createElement('select');kbSelect.className='knowledgeBaseSelect';kbSelect.style.width='100%';kbSelect.style.padding='5px';kbSelect.style.marginBottom='15px';kbSelect.style.borderRadius='3px';kbSelect.style.border='1px solid #ccc';kbSelect.disabled=true;const defaultKbOption=document.createElement('option');defaultKbOption.value='';defaultKbOption.textContent='-- Select a knowledge base --';kbSelect.appendChild(defaultKbOption);panel.appendChild(kbSelect);const statusDiv=document.createElement('div');statusDiv.id='llmPrimer-status';statusDiv.style.fontSize='13px';statusDiv.style.marginBottom='15px';statusDiv.style.color='#666';statusDiv.style.display='none';panel.appendChild(statusDiv);const buttonContainer=document.createElement('div');buttonContainer.style.display='flex';buttonContainer.style.justifyContent='space-between';buttonContainer.style.gap='10px';const injectBtn=document.createElement('button');injectBtn.id='llmPrimer-inject-btn';injectBtn.innerText='Inject Prompt';injectBtn.style.padding='8px 15px';injectBtn.style.borderRadius='3px';injectBtn.style.border='1px solid #ccc';injectBtn.style.backgroundColor='#f0f0f0';injectBtn.style.cursor='pointer';injectBtn.style.flex='1';injectBtn.disabled=true;injectBtn.addEventListener('click',injectPrompt);buttonContainer.appendChild(injectBtn);const copyBtn=document.createElement('button');copyBtn.id='llmPrimer-copy-btn';copyBtn.innerText='Copy Prompt';copyBtn.style.padding='8px 15px';copyBtn.style.borderRadius='3px';copyBtn.style.border='1px solid #ccc';copyBtn.style.backgroundColor='#f0f0f0';copyBtn.style.cursor='pointer';copyBtn.style.flex='1';copyBtn.disabled=true;copyBtn.addEventListener('click',copyPrompt);buttonContainer.appendChild(copyBtn);panel.appendChild(buttonContainer);document.body.appendChild(panel);categorySelect.addEventListener('change',function(){populateKnowledgeBases(this.value);kbSelect.disabled=!this.value;injectBtn.disabled=true;copyBtn.disabled=true;});kbSelect.addEventListener('change',function(){injectBtn.disabled=!this.value;copyBtn.disabled=!this.value;});if(typeof kbDomain==='undefined'||!Array.isArray(kbDomain)){throw new Error('Knowledge base domains not found or invalid');}if(kbCategory.length>0){categorySelect.value=kbCategory[0].id;populateKnowledgeBases(kbCategory[0].id);kbSelect.disabled=false;}applyCurrentTheme();}catch(error){console.error('Error initializing llmPrimer:',error);alert('Failed to initialize llmPrimer: '+error.message);}}function populateKnowledgeBases(categoryId){try{const kbSelect=document.querySelector('.knowledgeBaseSelect');if(!kbSelect){throw new Error('Knowledge base select element not found');}while(kbSelect.options.length>1){kbSelect.remove(1);}const filteredKBs=kbDomain.filter(kb=>kb.category===categoryId);filteredKBs.forEach(kb=>{const option=document.createElement('option');option.value=kb.id;option.textContent=kb.title;kbSelect.appendChild(option);});if(filteredKBs.length>0){kbSelect.value=filteredKBs[0].id;const injectBtn=document.getElementById('llmPrimer-inject-btn');const copyBtn=document.getElementById('llmPrimer-copy-btn');if(injectBtn&&copyBtn){injectBtn.disabled=false;copyBtn.disabled=false;}}}catch(error){console.error('Error populating knowledge bases:',error);alert('Failed to populate knowledge bases: '+error.message);}}function getDocxUrl(){try{const kbSelect=document.querySelector('.knowledgeBaseSelect');if(!kbSelect){throw new Error('Knowledge base select element not found');}const selectedId=kbSelect.value;if(!selectedId){return'';}const selectedKB=kbDomain.find(kb=>kb.id===selectedId);return selectedKB?selectedKB.docxUrl:'';}catch(error){console.error('Error getting DOCX URL:',error);return'';}}async function processDocx(url){try{if(!url){throw new Error('No valid DOCX URL provided');}updateStatus('Fetching DOCX file...');const response=await fetch(url);if(!response.ok){throw new Error(`Failed to fetch DOCX: ${response.status} ${response.statusText}`);}const arrayBuffer=await response.arrayBuffer();updateStatus('Converting DOCX to HTML...');const result=await mammoth.convertToHtml({arrayBuffer});const html=result.value;updateStatus('Converting HTML to Markdown...');const turndownService=new TurndownService();const markdown=turndownService.turndown(html);updateStatus('Conversion complete!');return markdown;}catch(error){console.error('Error processing DOCX:',error);updateStatus(`Error: ${error.message}`,true);throw error;}}function updateStatus(message,isError=false){const statusDiv=document.getElementById('llmPrimer-status');if(statusDiv){statusDiv.textContent=message;statusDiv.style.display='block';statusDiv.style.color=isError?'#dc3545':'#666';if(!isError&&message==='Conversion complete!'){setTimeout(()=>{statusDiv.style.display='none';},5000);}}}function notifySuccess(){console.log('Prompt injected successfully');}async function injectPrompt(){try{const docxUrl=getDocxUrl();if(!docxUrl){alert('No valid DOCX URL found. Please select a knowledge base.');return;}const markdown=await processDocx(docxUrl);const placeholder=document.querySelector("div#prompt-textarea p.placeholder");if(!placeholder){alert("Target placeholder not found! Please ensure you're on a compatible LLM interface.");return;}placeholder.innerText=markdown;placeholder.dispatchEvent(new Event("input",{bubbles:true}));setTimeout(()=>{const sendButton=document.querySelector('button[data-testid="send-button"]');if(sendButton){sendButton.click();notifySuccess();}else{alert("Send button not found! Prompt text was inserted but could not be sent automatically.");}},100);}catch(error){console.error('Error injecting prompt:',error);alert('Failed to inject prompt: '+error.message);}}async function copyPrompt(){try{const docxUrl=getDocxUrl();if(!docxUrl){alert('No knowledge base selected!');return;}const markdown=await processDocx(docxUrl);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(markdown).then(()=>{const copyBtn=document.getElementById('llmPrimer-copy-btn');if(copyBtn){const originalText=copyBtn.innerText;copyBtn.innerText='âœ“ Copied!';setTimeout(()=>{copyBtn.innerText=originalText;},2000);}else{alert('Markdown copied to clipboard!');}}).catch(error=>{console.error('Clipboard error:',error);alert('Failed to copy: '+error.message);});}else{const textarea=document.createElement('textarea');textarea.value=markdown;textarea.style.position='fixed';textarea.style.left='-999999px';textarea.style.top='-999999px';document.body.appendChild(textarea);textarea.focus();textarea.select();let success=false;try{success=document.execCommand('copy');}catch(error){console.error('Fallback clipboard error:',error);}document.body.removeChild(textarea);if(success){const copyBtn=document.getElementById('llmPrimer-copy-btn');if(copyBtn){const originalText=copyBtn.innerText;copyBtn.innerText='âœ“ Copied!';setTimeout(()=>{copyBtn.innerText=originalText;},2000);}else{alert('Markdown copied to clipboard!');}}else{alert('Failed to copy. Please select and copy manually: '+markdown);}}}catch(error){console.error('Error copying to clipboard:',error);alert('Failed to copy: '+error.message);}}function toggleTheme(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found');}const isDarkTheme=panel.getAttribute('data-theme')==='dark';if(isDarkTheme){panel.setAttribute('data-theme','light');panel.style.backgroundColor='#ffffff';panel.style.color='#333333';panel.style.border='1px solid #cccccc';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(button=>{button.style.backgroundColor='#f0f0f0';button.style.color='#333333';button.style.border='1px solid #cccccc';});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.backgroundColor='#ffffff';select.style.color='#333333';select.style.border='1px solid #cccccc';});}else{panel.setAttribute('data-theme','dark');panel.style.backgroundColor='#333333';panel.style.color='#ffffff';panel.style.border='1px solid #555555';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(button=>{button.style.backgroundColor='#444444';button.style.color='#ffffff';button.style.border='1px solid #666666';});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.backgroundColor='#444444';select.style.color='#ffffff';select.style.border='1px solid #666666';});}localStorage.setItem('llmPrimer-theme',isDarkTheme?'light':'dark');}catch(error){console.error('Error toggling theme:',error);}}function applyCurrentTheme(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found');}const savedTheme=localStorage.getItem('llmPrimer-theme')||'light';if(savedTheme==='dark'){panel.setAttribute('data-theme','dark');panel.style.backgroundColor='#333333';panel.style.color='#ffffff';panel.style.border='1px solid #555555';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(button=>{button.style.backgroundColor='#444444';button.style.color='#ffffff';button.style.border='1px solid #666666';});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.backgroundColor='#444444';select.style.color='#ffffff';select.style.border='1px solid #666666';});}else{panel.setAttribute('data-theme','light');panel.style.backgroundColor='#ffffff';panel.style.color='#333333';panel.style.border='1px solid #cccccc';const buttons=panel.querySelectorAll('button:not([id="llmPrimer-theme-btn"]):not([id="llmPrimer-toggle-btn"]):not([id="llmPrimer-close-btn"])');buttons.forEach(button=>{button.style.backgroundColor='#f0f0f0';button.style.color='#333333';button.style.border='1px solid #cccccc';});const selects=panel.querySelectorAll('select');selects.forEach(select=>{select.style.backgroundColor='#ffffff';select.style.color='#333333';select.style.border='1px solid #cccccc';});}}catch(error){console.error('Error applying theme:',error);}}function minimizePanel(){try{const panel=document.getElementById('llmPrimer-panel');if(!panel){throw new Error('Panel element not found');}const childElements=Array.from(panel.children).slice(1);const isMinimized=panel.getAttribute('data-minimized')==='true';if(isMinimized){childElements.forEach(element=>{element.style.display='';});panel.setAttribute('data-minimized','false');}else{childElements.forEach(element=>{element.style.display='none';});panel.setAttribute('data-minimized','true');}}catch(error){console.error('Error toggling panel:',error);}}function closePanel(){try{const panel=document.getElementById('llmPrimer-panel');if(panel){panel.remove();}}catch(error){console.error('Error closing panel:',error);}}})();